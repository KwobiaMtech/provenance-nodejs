"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Provenance = void 0;
const provenance = require("@provenanceio/provenance.js");
const bip39 = require("bip39");
const createHmac = require("crypto");
const stargate_1 = require("@cosmjs/stargate");
const proto_signing_1 = require("@cosmjs/proto-signing");
const tx_1 = require("cosmjs-types/cosmos/bank/v1beta1/tx");
const tx_2 = require("cosmjs-types/cosmos/tx/v1beta1/tx");
const crypto_1 = require("@cosmjs/crypto");
const config_provenance_1 = require("../config/config.provenance");
class Provenance {
    constructor(environment) {
        Provenance._environment = environment || "TEST_NET";
    }
    get client() {
        return Provenance._client;
    }
    get environment() {
        return Provenance._environment;
    }
    set environment(environment) {
        Provenance._environment = environment;
    }
    static async build() {
        Provenance._client = await stargate_1.StargateClient.connect(Provenance._environment === "MAIN_NET"
            ? config_provenance_1.PROVENANCE_CONFIG.MAIN_NET.PROVENANCE_RPC_URL
            : config_provenance_1.PROVENANCE_CONFIG.TEST_NET.PROVENANCE_RPC_URL);
        return new Provenance();
    }
    createWallet() {
        const MASTER_SECRET = Buffer.from("Bitcoin seed", "utf8");
        const PRIVATE_KEY_SIZE = 32;
        const CHAINCODE_SIZE = 32;
        const mnemonic = bip39.generateMnemonic();
        const seed = bip39.mnemonicToSeedSync(mnemonic);
        const hmac = createHmac.createHmac("sha512", MASTER_SECRET);
        hmac.update(seed);
        const digest = hmac.digest();
        const privateKey = Buffer.from(digest.subarray(0, PRIVATE_KEY_SIZE));
        const chainCode = Buffer.from(digest.subarray(PRIVATE_KEY_SIZE, PRIVATE_KEY_SIZE + CHAINCODE_SIZE));
        const wallet = provenance.Wallet.fromPrivateKey(privateKey, chainCode, this.environment === "MAIN_NET" ? true : false);
        const getKey = wallet.getKey(0, 0);
        return {
            privateKey: privateKey.toString("hex"),
            address: getKey.address,
            publicKey: getKey.publicKey,
            mnemonicPhrase: mnemonic,
        };
    }
    async getBalance(address) {
        return await this.client.getBalance(address, "nhash");
    }
    async getTransactionDetails(txHash) {
        const faucetTx = await this.client.getTx(txHash);
        const decodedTx = tx_2.Tx.decode(faucetTx.tx);
        const sentMessage = tx_1.MsgSend.decode(decodedTx.body.messages[0].value);
        const hash = Number(sentMessage.amount[0].amount) / 1e9;
        return {
            senderAddress: sentMessage.fromAddress,
            receiverAddress: sentMessage.toAddress,
            tokenMintAddress: sentMessage.amount[0].denom,
            amount: hash,
        };
    }
    async convertToHash(amount) {
        return amount * 1e9;
    }
    async createTransaction(senderAddress, receiverAddress, senderMnemonic, amount) {
        amount = 1000000000 * amount;
        const senderBalance = await this.getBalance(senderAddress);
        if (Number(senderBalance.amount) < amount) {
            throw new Error(`Sender account balance not sufficient. Current balance ${senderBalance.amount}`);
        }
        const path = (0, crypto_1.stringToPath)(this.environment === "MAIN_NET"
            ? config_provenance_1.PROVENANCE_CONFIG.MAIN_NET.PROVENANCE_HDPATH
            : config_provenance_1.PROVENANCE_CONFIG.TEST_NET.PROVENANCE_HDPATH);
        const signer = await proto_signing_1.DirectSecp256k1HdWallet.fromMnemonic(senderMnemonic, {
            prefix: this.environment === "MAIN_NET"
                ? config_provenance_1.PROVENANCE_CONFIG.MAIN_NET.PROVENANCE_HRP
                : config_provenance_1.PROVENANCE_CONFIG.TEST_NET.PROVENANCE_HRP,
            hdPaths: [path],
        });
        const signerAccount = await signer.getAccounts();
        const signerAddress = signerAccount[0].address;
        if (signerAddress !== senderAddress) {
        }
        const signingClient = await stargate_1.SigningStargateClient.connectWithSigner(this.environment === "MAIN_NET"
            ? config_provenance_1.PROVENANCE_CONFIG.MAIN_NET.PROVENANCE_RPC_URL
            : config_provenance_1.PROVENANCE_CONFIG.TEST_NET.PROVENANCE_RPC_URL, signer);
        const result = await signingClient.sendTokens(signerAddress, receiverAddress, [{ denom: "nhash", amount: amount.toString() }], {
            amount: [{ denom: "nhash", amount: "2502007950" }],
            gas: "131339",
        });
        return {
            gasUsed: result.gasUsed,
            gasWanted: result.gasWanted,
            transactionHash: result.transactionHash,
        };
    }
}
exports.Provenance = Provenance;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmVuYW5jZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NlcnZpY2VzL3Byb3ZlbmFuY2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHQSwwREFBMEQ7QUFDMUQsK0JBQStCO0FBQy9CLHFDQUFxQztBQUNyQywrQ0FJMEI7QUFDMUIseURBRytCO0FBQy9CLDREQUE4RDtBQUM5RCwwREFBdUQ7QUFDdkQsMkNBQThDO0FBQzlDLG1FQUFnRTtBQUVoRSxNQUFhLFVBQVU7SUFJckIsWUFBWSxXQUFxQztRQUMvQyxVQUFVLENBQUMsWUFBWSxHQUFHLFdBQVcsSUFBSSxVQUFVLENBQUM7SUFDdEQsQ0FBQztJQUVELElBQUksTUFBTTtRQUNSLE9BQU8sVUFBVSxDQUFDLE9BQU8sQ0FBQztJQUM1QixDQUFDO0lBRUQsSUFBSSxXQUFXO1FBQ2IsT0FBTyxVQUFVLENBQUMsWUFBWSxDQUFDO0lBQ2pDLENBQUM7SUFFRCxJQUFJLFdBQVcsQ0FBQyxXQUFvQztRQUNsRCxVQUFVLENBQUMsWUFBWSxHQUFHLFdBQVcsQ0FBQztJQUN4QyxDQUFDO0lBRU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLO1FBQ3ZCLFVBQVUsQ0FBQyxPQUFPLEdBQUcsTUFBTSx5QkFBYyxDQUFDLE9BQU8sQ0FDL0MsVUFBVSxDQUFDLFlBQVksS0FBSyxVQUFVO1lBQ3BDLENBQUMsQ0FBQyxxQ0FBaUIsQ0FBQyxRQUFRLENBQUMsa0JBQWtCO1lBQy9DLENBQUMsQ0FBQyxxQ0FBaUIsQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQ2xELENBQUM7UUFFRixPQUFPLElBQUksVUFBVSxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVELFlBQVk7UUFDVixNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMxRCxNQUFNLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztRQUM1QixN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QUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxFQUMvQztZQUNFLE1BQU0sRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLENBQUM7WUFDbEQsR0FBRyxFQUFFLFFBQVE7U0FDZCxDQUNGLENBQUM7UUFDRixPQUFPO1lBQ0wsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPO1lBQ3ZCLFNBQVMsRUFBRSxNQUFNLENBQUMsU0FBUztZQUMzQixlQUFlLEVBQUUsTUFBTSxDQUFDLGVBQWU7U0FDeEMsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQTlJRCxnQ0E4SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcm92ZW5hbmNlVHJhbnNhY3Rpb25EZXRhaWxzIH0gZnJvbSBcInR5cGVzL3Byb3ZlbmFuY2UtdHJhbnNhY3Rpb24tZGV0YWlscy50eXBlXCI7XG5pbXBvcnQgeyBQcm92ZW5hbmNlV2FsbGV0IH0gZnJvbSBcInR5cGVzL3Byb3ZlbmFuY2Utd2FsbGV0LnR5cGVcIjtcblxuaW1wb3J0ICogYXMgcHJvdmVuYW5jZSBmcm9tIFwiQHByb3ZlbmFuY2Vpby9wcm92ZW5hbmNlLmpzXCI7XG5pbXBvcnQgKiBhcyBiaXAzOSBmcm9tIFwiYmlwMzlcIjtcbmltcG9ydCAqIGFzIGNyZWF0ZUhtYWMgZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IHtcbiAgSW5kZXhlZFR4LFxuICBTdGFyZ2F0ZUNsaWVudCxcbiAgU2lnbmluZ1N0YXJnYXRlQ2xpZW50LFxufSBmcm9tIFwiQGNvc21qcy9zdGFyZ2F0ZVwiO1xuaW1wb3J0IHtcbiAgRGlyZWN0U2VjcDI1NmsxSGRXYWxsZXQsXG4gIE9mZmxpbmVEaXJlY3RTaWduZXIsXG59IGZyb20gXCJAY29zbWpzL3Byb3RvLXNpZ25pbmdcIjtcbmltcG9ydCB7IE1zZ1NlbmQgfSBmcm9tIFwiY29zbWpzLXR5cGVzL2Nvc21vcy9iYW5rL3YxYmV0YTEvdHhcIjtcbmltcG9ydCB7IFR4IH0gZnJvbSBcImNvc21qcy10eXBlcy9jb3Ntb3MvdHgvdjFiZXRhMS90eFwiO1xuaW1wb3J0IHsgc3RyaW5nVG9QYXRoIH0gZnJvbSBcIkBjb3NtanMvY3J5cHRvXCI7XG5pbXBvcnQgeyBQUk9WRU5BTkNFX0NPTkZJRyB9IGZyb20gXCIuLi9jb25maWcvY29uZmlnLnByb3ZlbmFuY2VcIjtcblxuZXhwb3J0IGNsYXNzIFByb3ZlbmFuY2Uge1xuICBwcml2YXRlIHN0YXRpYyBfY2xpZW50OiBTdGFyZ2F0ZUNsaWVudDtcbiAgcHJpdmF0ZSBzdGF0aWMgX2Vudmlyb25tZW50OiBcIlRFU1RfTkVUXCIgfCBcIk1BSU5fTkVUXCI7XG5cbiAgY29uc3RydWN0b3IoZW52aXJvbm1lbnQ/OiBcIlRFU1RfTkVUXCIgfCBcIk1BSU5fTkVUXCIpIHtcbiAgICBQcm92ZW5hbmNlLl9lbnZpcm9ubWVudCA9IGVudmlyb25tZW50IHx8IFwiVEVTVF9ORVRcIjtcbiAgfVxuXG4gIGdldCBjbGllbnQoKSB7XG4gICAgcmV0dXJuIFByb3ZlbmFuY2UuX2NsaWVudDtcbiAgfVxuXG4gIGdldCBlbnZpcm9ubWVudCgpIHtcbiAgICByZXR1cm4gUHJvdmVuYW5jZS5fZW52aXJvbm1lbnQ7XG4gIH1cblxuICBzZXQgZW52aXJvbm1lbnQoZW52aXJvbm1lbnQ6IFwiVEVTVF9ORVRcIiB8IFwiTUFJTl9ORVRcIikge1xuICAgIFByb3ZlbmFuY2UuX2Vudmlyb25tZW50ID0gZW52aXJvbm1lbnQ7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGFzeW5jIGJ1aWxkKCk6IFByb21pc2U8UHJvdmVuYW5jZT4ge1xuICAgIFByb3ZlbmFuY2UuX2NsaWVudCA9IGF3YWl0IFN0YXJnYXRlQ2xpZW50LmNvbm5lY3QoXG4gICAgICBQcm92ZW5hbmNlLl9lbnZpcm9ubWVudCA9PT0gXCJNQUlOX05FVFwiXG4gICAgICAgID8gUFJPVkVOQU5DRV9DT05GSUcuTUFJTl9ORVQuUFJPVkVOQU5DRV9SUENfVVJMXG4gICAgICAgIDogUFJPVkVOQU5DRV9DT05GSUcuVEVTVF9ORVQuUFJPVkVOQU5DRV9SUENfVVJMXG4gICAgKTtcblxuICAgIHJldHVybiBuZXcgUHJvdmVuYW5jZSgpO1xuICB9XG5cbiAgY3JlYXRlV2FsbGV0KCk6IFByb3ZlbmFuY2VXYWxsZXQge1xuICAgIGNvbnN0IE1BU1RFUl9TRUNSRVQgPSBCdWZmZXIuZnJvbShcIkJpdGNvaW4gc2VlZFwiLCBcInV0ZjhcIik7XG4gICAgY29uc3QgUFJJVkFURV9LRVlfU0laRSA9IDMyO1xuICAgIGNvbnN0IENIQUlOQ09ERV9TSVpFID0gMzI7XG5cbiAgICBjb25zdCBtbmVtb25pYyA9IGJpcDM5LmdlbmVyYXRlTW5lbW9uaWMoKTtcbiAgICBjb25zdCBzZWVkID0gYmlwMzkubW5lbW9uaWNUb1NlZWRTeW5jKG1uZW1vbmljKTtcbiAgICBjb25zdCBobWFjID0gY3JlYXRlSG1hYy5jcmVhdGVIbWFjKFwic2hhNTEyXCIsIE1BU1RFUl9TRUNSRVQpO1xuICAgIGhtYWMudXBkYXRlKHNlZWQpO1xuICAgIGNvbnN0IGRpZ2VzdCA9IGhtYWMuZGlnZXN0KCk7XG4gICAgY29uc3QgcHJpdmF0ZUtleSA9IEJ1ZmZlci5mcm9tKGRpZ2VzdC5zdWJhcnJheSgwLCBQUklWQVRFX0tFWV9TSVpFKSk7XG4gICAgY29uc3QgY2hhaW5Db2RlID0gQnVmZmVyLmZyb20oXG4gICAgICBkaWdlc3Quc3ViYXJyYXkoUFJJVkFURV9LRVlfU0laRSwgUFJJVkFURV9LRVlfU0laRSArIENIQUlOQ09ERV9TSVpFKVxuICAgICk7XG5cbiAgICBjb25zdCB3YWxsZXQgPSBwcm92ZW5hbmNlLldhbGxldC5mcm9tUHJpdmF0ZUtleShcbiAgICAgIHByaXZhdGVLZXksXG4gICAgICBjaGFpbkNvZGUsXG4gICAgICB0aGlzLmVudmlyb25tZW50ID09PSBcIk1BSU5fTkVUXCIgPyB0cnVlIDogZmFsc2VcbiAgICApO1xuICAgIGNvbnN0IGdldEtleSA9IHdhbGxldC5nZXRLZXkoMCwgMCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgcHJpdmF0ZUtleTogcHJpdmF0ZUtleS50b1N0cmluZyhcImhleFwiKSxcbiAgICAgIGFkZHJlc3M6IGdldEtleS5hZGRyZXNzLFxuICAgICAgcHVibGljS2V5OiBnZXRLZXkucHVibGljS2V5LFxuICAgICAgbW5lbW9uaWNQaHJhc2U6IG1uZW1vbmljLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0QmFsYW5jZShhZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPHByb3ZlbmFuY2UuQ29pbj4ge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmNsaWVudC5nZXRCYWxhbmNlKGFkZHJlc3MsIFwibmhhc2hcIik7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0VHJhbnNhY3Rpb25EZXRhaWxzKFxuICAgIHR4SGFzaDogc3RyaW5nXG4gICk6IFByb21pc2U8UHJvdmVuYW5jZVRyYW5zYWN0aW9uRGV0YWlscz4ge1xuICAgIGNvbnN0IGZhdWNldFR4OiBJbmRleGVkVHggPSBhd2FpdCB0aGlzLmNsaWVudC5nZXRUeCh0eEhhc2gpO1xuXG4gICAgY29uc3QgZGVjb2RlZFR4OiBUeCA9IFR4LmRlY29kZShmYXVjZXRUeC50eCk7XG5cbiAgICBjb25zdCBzZW50TWVzc2FnZTogTXNnU2VuZCA9IE1zZ1NlbmQuZGVjb2RlKFxuICAgICAgZGVjb2RlZFR4LmJvZHkubWVzc2FnZXNbMF0udmFsdWVcbiAgICApO1xuICAgIGNvbnN0IGhhc2ggPSBOdW1iZXIoc2VudE1lc3NhZ2UuYW1vdW50WzBdLmFtb3VudCkgLyAxZTk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNlbmRlckFkZHJlc3M6IHNlbnRNZXNzYWdlLmZyb21BZGRyZXNzLFxuICAgICAgcmVjZWl2ZXJBZGRyZXNzOiBzZW50TWVzc2FnZS50b0FkZHJlc3MsXG4gICAgICB0b2tlbk1pbnRBZGRyZXNzOiBzZW50TWVzc2FnZS5hbW91bnRbMF0uZGVub20sXG4gICAgICBhbW91bnQ6IGhhc2gsXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjb252ZXJ0VG9IYXNoKGFtb3VudDogbnVtYmVyKSB7XG4gICAgcmV0dXJuIGFtb3VudCAqIDFlOTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjcmVhdGVUcmFuc2FjdGlvbihcbiAgICBzZW5kZXJBZGRyZXNzOiBzdHJpbmcsXG4gICAgcmVjZWl2ZXJBZGRyZXNzOiBzdHJpbmcsXG4gICAgc2VuZGVyTW5lbW9uaWM6IHN0cmluZyxcbiAgICBhbW91bnQ6IG51bWJlclxuICApOiBQcm9taXNlPHsgZ2FzVXNlZDogbnVtYmVyOyBnYXNXYW50ZWQ6IG51bWJlcjsgdHJhbnNhY3Rpb25IYXNoOiBzdHJpbmcgfT4ge1xuICAgIGFtb3VudCA9IDEwMDAwMDAwMDAgKiBhbW91bnQ7XG4gICAgY29uc3Qgc2VuZGVyQmFsYW5jZSA9IGF3YWl0IHRoaXMuZ2V0QmFsYW5jZShzZW5kZXJBZGRyZXNzKTtcbiAgICBpZiAoTnVtYmVyKHNlbmRlckJhbGFuY2UuYW1vdW50KSA8IGFtb3VudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgU2VuZGVyIGFjY291bnQgYmFsYW5jZSBub3Qgc3VmZmljaWVudC4gQ3VycmVudCBiYWxhbmNlICR7c2VuZGVyQmFsYW5jZS5hbW91bnR9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBwYXRoID0gc3RyaW5nVG9QYXRoKFxuICAgICAgdGhpcy5lbnZpcm9ubWVudCA9PT0gXCJNQUlOX05FVFwiXG4gICAgICAgID8gUFJPVkVOQU5DRV9DT05GSUcuTUFJTl9ORVQuUFJPVkVOQU5DRV9IRFBBVEhcbiAgICAgICAgOiBQUk9WRU5BTkNFX0NPTkZJRy5URVNUX05FVC5QUk9WRU5BTkNFX0hEUEFUSFxuICAgICk7XG5cbiAgICBjb25zdCBzaWduZXI6IE9mZmxpbmVEaXJlY3RTaWduZXIgPVxuICAgICAgYXdhaXQgRGlyZWN0U2VjcDI1NmsxSGRXYWxsZXQuZnJvbU1uZW1vbmljKHNlbmRlck1uZW1vbmljLCB7XG4gICAgICAgIHByZWZpeDpcbiAgICAgICAgICB0aGlzLmVudmlyb25tZW50ID09PSBcIk1BSU5fTkVUXCJcbiAgICAgICAgICAgID8gUFJPVkVOQU5DRV9DT05GSUcuTUFJTl9ORVQuUFJPVkVOQU5DRV9IUlBcbiAgICAgICAgICAgIDogUFJPVkVOQU5DRV9DT05GSUcuVEVTVF9ORVQuUFJPVkVOQU5DRV9IUlAsXG4gICAgICAgIGhkUGF0aHM6IFtwYXRoXSxcbiAgICAgIH0pO1xuICAgIGNvbnN0IHNpZ25lckFjY291bnQgPSBhd2FpdCBzaWduZXIuZ2V0QWNjb3VudHMoKTtcbiAgICBjb25zdCBzaWduZXJBZGRyZXNzID0gc2lnbmVyQWNjb3VudFswXS5hZGRyZXNzO1xuICAgIGlmIChzaWduZXJBZGRyZXNzICE9PSBzZW5kZXJBZGRyZXNzKSB7XG4gICAgfVxuXG4gICAgY29uc3Qgc2lnbmluZ0NsaWVudCA9IGF3YWl0IFNpZ25pbmdTdGFyZ2F0ZUNsaWVudC5jb25uZWN0V2l0aFNpZ25lcihcbiAgICAgIHRoaXMuZW52aXJvbm1lbnQgPT09IFwiTUFJTl9ORVRcIlxuICAgICAgICA/IFBST1ZFTkFOQ0VfQ09ORklHLk1BSU5fTkVULlBST1ZFTkFOQ0VfUlBDX1VSTFxuICAgICAgICA6IFBST1ZFTkFOQ0VfQ09ORklHLlRFU1RfTkVULlBST1ZFTkFOQ0VfUlBDX1VSTCxcbiAgICAgIHNpZ25lclxuICAgICk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzaWduaW5nQ2xpZW50LnNlbmRUb2tlbnMoXG4gICAgICBzaWduZXJBZGRyZXNzLFxuICAgICAgcmVjZWl2ZXJBZGRyZXNzLFxuICAgICAgW3sgZGVub206IFwibmhhc2hcIiwgYW1vdW50OiBhbW91bnQudG9TdHJpbmcoKSB9XSxcbiAgICAgIHtcbiAgICAgICAgYW1vdW50OiBbeyBkZW5vbTogXCJuaGFzaFwiLCBhbW91bnQ6IFwiMjUwMjAwNzk1MFwiIH1dLFxuICAgICAgICBnYXM6IFwiMTMxMzM5XCIsXG4gICAgICB9XG4gICAgKTtcbiAgICByZXR1cm4ge1xuICAgICAgZ2FzVXNlZDogcmVzdWx0Lmdhc1VzZWQsXG4gICAgICBnYXNXYW50ZWQ6IHJlc3VsdC5nYXNXYW50ZWQsXG4gICAgICB0cmFuc2FjdGlvbkhhc2g6IHJlc3VsdC50cmFuc2FjdGlvbkhhc2gsXG4gICAgfTtcbiAgfVxufVxuIl19