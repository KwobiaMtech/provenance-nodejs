"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProvenanceService = void 0;
const provenance = require("@provenanceio/provenance.js");
const bip39 = require("bip39");
const createHmac = require("crypto");
const stargate_1 = require("@cosmjs/stargate");
const proto_signing_1 = require("@cosmjs/proto-signing");
const tx_1 = require("cosmjs-types/cosmos/bank/v1beta1/tx");
const tx_2 = require("cosmjs-types/cosmos/tx/v1beta1/tx");
const crypto_1 = require("@cosmjs/crypto");
const config_provenance_1 = require("../config/config.provenance");
class ProvenanceService {
    constructor(environment) {
        this.environment = environment;
    }
    async init() {
        var _a;
        this.client = await stargate_1.StargateClient.connect(this.environment === "MAIN_NET"
            ? config_provenance_1.PROVENANCE_CONFIG.MAIN_NET.PROVENANCE_RPC_URL
            : config_provenance_1.PROVENANCE_CONFIG.TEST_NET.PROVENANCE_RPC_URL);
        return new ProvenanceService((_a = this.environment) !== null && _a !== void 0 ? _a : "TEST_NET");
    }
    setEnvironment(environment) {
        this.environment = environment;
    }
    getEnvironment() {
        return this.environment;
    }
    createProvenanceWallet() {
        const MASTER_SECRET = Buffer.from("Bitcoin seed", "utf8");
        const PRIVATE_KEY_SIZE = 32;
        const CHAINCODE_SIZE = 32;
        const mnemonic = bip39.generateMnemonic();
        const seed = bip39.mnemonicToSeedSync(mnemonic);
        const hmac = createHmac.createHmac("sha512", MASTER_SECRET);
        hmac.update(seed);
        const digest = hmac.digest();
        const privateKey = Buffer.from(digest.subarray(0, PRIVATE_KEY_SIZE));
        const chainCode = Buffer.from(digest.subarray(PRIVATE_KEY_SIZE, PRIVATE_KEY_SIZE + CHAINCODE_SIZE));
        const wallet = provenance.Wallet.fromPrivateKey(privateKey, chainCode, this.environment === "MAIN_NET" ? true : false);
        const getKey = wallet.getKey(0, 0);
        return {
            privateKey: privateKey.toString("hex"),
            address: getKey.address,
            publicKey: getKey.publicKey,
            mnemonicPhrase: mnemonic,
        };
    }
    async getBalance(address) {
        return await this.client.getBalance(address, "nhash");
    }
    async getTransactionDetails(txHash) {
        const faucetTx = await this.client.getTx(txHash);
        const decodedTx = tx_2.Tx.decode(faucetTx.tx);
        const sentMessage = tx_1.MsgSend.decode(decodedTx.body.messages[0].value);
        const hash = Number(sentMessage.amount[0].amount) / 1e9;
        return {
            senderAddress: sentMessage.fromAddress,
            receiverAddress: sentMessage.toAddress,
            tokenMintAddress: sentMessage.amount[0].denom,
            amount: hash,
        };
    }
    async createTransaction(senderAddress, receiverAddress, senderMnemonic, amount) {
        amount = 1000000000 * amount;
        const senderBalance = await this.getBalance(senderAddress);
        if (Number(senderBalance.amount) < amount) {
            throw new Error(`Sender account balance not sufficient. Current balance ${senderBalance.amount}`);
        }
        const path = (0, crypto_1.stringToPath)(this.environment === "MAIN_NET"
            ? config_provenance_1.PROVENANCE_CONFIG.MAIN_NET.PROVENANCE_HDPATH
            : config_provenance_1.PROVENANCE_CONFIG.TEST_NET.PROVENANCE_HDPATH);
        const signer = await proto_signing_1.DirectSecp256k1HdWallet.fromMnemonic(senderMnemonic, {
            prefix: this.environment === "MAIN_NET"
                ? config_provenance_1.PROVENANCE_CONFIG.MAIN_NET.PROVENANCE_HRP
                : config_provenance_1.PROVENANCE_CONFIG.TEST_NET.PROVENANCE_HRP,
            hdPaths: [path],
        });
        const signerAccount = await signer.getAccounts();
        const signerAddress = signerAccount[0].address;
        if (signerAddress !== senderAddress) {
        }
        const signingClient = await stargate_1.SigningStargateClient.connectWithSigner(this.environment === "MAIN_NET"
            ? config_provenance_1.PROVENANCE_CONFIG.MAIN_NET.PROVENANCE_RPC_URL
            : config_provenance_1.PROVENANCE_CONFIG.TEST_NET.PROVENANCE_RPC_URL, signer);
        const result = await signingClient.sendTokens(signerAddress, receiverAddress, [{ denom: "nhash", amount: amount.toString() }], {
            amount: [{ denom: "nhash", amount: "2502007950" }],
            gas: "131339",
        });
        return {
            gasUsed: result.gasUsed,
            gasWanted: result.gasWanted,
            transactionHash: result.transactionHash,
        };
    }
}
exports.ProvenanceService = ProvenanceService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmVuYW5jZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NlcnZpY2VzL3Byb3ZlbmFuY2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHQSwwREFBMEQ7QUFDMUQsK0JBQStCO0FBQy9CLHFDQUFxQztBQUNyQywrQ0FJMEI7QUFDMUIseURBRytCO0FBQy9CLDREQUE4RDtBQUM5RCwwREFBdUQ7QUFDdkQsMkNBQThDO0FBQzlDLG1FQUFnRTtBQUVoRSxNQUFhLGlCQUFpQjtJQUc1QixZQUFZLFdBQXFDO1FBQy9DLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0lBQ2pDLENBQUM7SUFFTSxLQUFLLENBQUMsSUFBSTs7UUFDZixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0seUJBQWMsQ0FBQyxPQUFPLENBQ3hDLElBQUksQ0FBQyxXQUFXLEtBQUssVUFBVTtZQUM3QixDQUFDLENBQUMscUNBQWlCLENBQUMsUUFBUSxDQUFDLGtCQUFrQjtZQUMvQyxDQUFDLENBQUMscUNBQWlCLENBQUMsUUFBUSxDQUFDLGtCQUFrQixDQUNsRCxDQUFDO1FBQ0YsT0FBTyxJQUFJLGlCQUFpQixDQUFDLE1BQUEsSUFBSSxDQUFDLFdBQVcsbUNBQUksVUFBVSxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQUVELGNBQWMsQ0FBQyxXQUFvQztRQUNqRCxJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztJQUNqQyxDQUFDO0lBRUQsY0FBYztRQUNaLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDO0lBRUQsc0JBQXNCO1FBQ3BCLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzFELE1BQU0sZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzVCLE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQztRQUUxQixNQUFNLFFBQVEsR0FB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UUFBUTtTQUNkLENBQ0YsQ0FBQztRQUNGLE9BQU87WUFDTCxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU87WUFDdkIsU0FBUyxFQUFFLE1BQU0sQ0FBQyxTQUFTO1lBQzNCLGVBQWUsRUFBRSxNQUFNLENBQUMsZUFBZTtTQUN4QyxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBcElELDhDQW9JQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb3ZlbmFuY2VUcmFuc2FjdGlvbkRldGFpbHMgfSBmcm9tIFwidHlwZXMvcHJvdmVuYW5jZS10cmFuc2FjdGlvbi1kZXRhaWxzLnR5cGVcIjtcbmltcG9ydCB7IFByb3ZlbmFuY2VXYWxsZXQgfSBmcm9tIFwidHlwZXMvcHJvdmVuYW5jZS13YWxsZXQudHlwZVwiO1xuXG5pbXBvcnQgKiBhcyBwcm92ZW5hbmNlIGZyb20gXCJAcHJvdmVuYW5jZWlvL3Byb3ZlbmFuY2UuanNcIjtcbmltcG9ydCAqIGFzIGJpcDM5IGZyb20gXCJiaXAzOVwiO1xuaW1wb3J0ICogYXMgY3JlYXRlSG1hYyBmcm9tIFwiY3J5cHRvXCI7XG5pbXBvcnQge1xuICBJbmRleGVkVHgsXG4gIFN0YXJnYXRlQ2xpZW50LFxuICBTaWduaW5nU3RhcmdhdGVDbGllbnQsXG59IGZyb20gXCJAY29zbWpzL3N0YXJnYXRlXCI7XG5pbXBvcnQge1xuICBEaXJlY3RTZWNwMjU2azFIZFdhbGxldCxcbiAgT2ZmbGluZURpcmVjdFNpZ25lcixcbn0gZnJvbSBcIkBjb3NtanMvcHJvdG8tc2lnbmluZ1wiO1xuaW1wb3J0IHsgTXNnU2VuZCB9IGZyb20gXCJjb3NtanMtdHlwZXMvY29zbW9zL2JhbmsvdjFiZXRhMS90eFwiO1xuaW1wb3J0IHsgVHggfSBmcm9tIFwiY29zbWpzLXR5cGVzL2Nvc21vcy90eC92MWJldGExL3R4XCI7XG5pbXBvcnQgeyBzdHJpbmdUb1BhdGggfSBmcm9tIFwiQGNvc21qcy9jcnlwdG9cIjtcbmltcG9ydCB7IFBST1ZFTkFOQ0VfQ09ORklHIH0gZnJvbSBcIi4uL2NvbmZpZy9jb25maWcucHJvdmVuYW5jZVwiO1xuXG5leHBvcnQgY2xhc3MgUHJvdmVuYW5jZVNlcnZpY2Uge1xuICBwcml2YXRlIGNsaWVudDogU3RhcmdhdGVDbGllbnQ7XG4gIHByaXZhdGUgZW52aXJvbm1lbnQ6IFwiVEVTVF9ORVRcIiB8IFwiTUFJTl9ORVRcIjtcbiAgY29uc3RydWN0b3IoZW52aXJvbm1lbnQ/OiBcIlRFU1RfTkVUXCIgfCBcIk1BSU5fTkVUXCIpIHtcbiAgICB0aGlzLmVudmlyb25tZW50ID0gZW52aXJvbm1lbnQ7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5pdCgpIHtcbiAgICB0aGlzLmNsaWVudCA9IGF3YWl0IFN0YXJnYXRlQ2xpZW50LmNvbm5lY3QoXG4gICAgICB0aGlzLmVudmlyb25tZW50ID09PSBcIk1BSU5fTkVUXCJcbiAgICAgICAgPyBQUk9WRU5BTkNFX0NPTkZJRy5NQUlOX05FVC5QUk9WRU5BTkNFX1JQQ19VUkxcbiAgICAgICAgOiBQUk9WRU5BTkNFX0NPTkZJRy5URVNUX05FVC5QUk9WRU5BTkNFX1JQQ19VUkxcbiAgICApO1xuICAgIHJldHVybiBuZXcgUHJvdmVuYW5jZVNlcnZpY2UodGhpcy5lbnZpcm9ubWVudCA/PyBcIlRFU1RfTkVUXCIpO1xuICB9XG5cbiAgc2V0RW52aXJvbm1lbnQoZW52aXJvbm1lbnQ6IFwiVEVTVF9ORVRcIiB8IFwiTUFJTl9ORVRcIikge1xuICAgIHRoaXMuZW52aXJvbm1lbnQgPSBlbnZpcm9ubWVudDtcbiAgfVxuXG4gIGdldEVudmlyb25tZW50KCkge1xuICAgIHJldHVybiB0aGlzLmVudmlyb25tZW50O1xuICB9XG5cbiAgY3JlYXRlUHJvdmVuYW5jZVdhbGxldCgpOiBQcm92ZW5hbmNlV2FsbGV0IHtcbiAgICBjb25zdCBNQVNURVJfU0VDUkVUID0gQnVmZmVyLmZyb20oXCJCaXRjb2luIHNlZWRcIiwgXCJ1dGY4XCIpO1xuICAgIGNvbnN0IFBSSVZBVEVfS0VZX1NJWkUgPSAzMjtcbiAgICBjb25zdCBDSEFJTkNPREVfU0laRSA9IDMyO1xuXG4gICAgY29uc3QgbW5lbW9uaWMgPSBiaXAzOS5nZW5lcmF0ZU1uZW1vbmljKCk7XG4gICAgY29uc3Qgc2VlZCA9IGJpcDM5Lm1uZW1vbmljVG9TZWVkU3luYyhtbmVtb25pYyk7XG4gICAgY29uc3QgaG1hYyA9IGNyZWF0ZUhtYWMuY3JlYXRlSG1hYyhcInNoYTUxMlwiLCBNQVNURVJfU0VDUkVUKTtcbiAgICBobWFjLnVwZGF0ZShzZWVkKTtcbiAgICBjb25zdCBkaWdlc3QgPSBobWFjLmRpZ2VzdCgpO1xuICAgIGNvbnN0IHByaXZhdGVLZXkgPSBCdWZmZXIuZnJvbShkaWdlc3Quc3ViYXJyYXkoMCwgUFJJVkFURV9LRVlfU0laRSkpO1xuICAgIGNvbnN0IGNoYWluQ29kZSA9IEJ1ZmZlci5mcm9tKFxuICAgICAgZGlnZXN0LnN1YmFycmF5KFBSSVZBVEVfS0VZX1NJWkUsIFBSSVZBVEVfS0VZX1NJWkUgKyBDSEFJTkNPREVfU0laRSlcbiAgICApO1xuXG4gICAgY29uc3Qgd2FsbGV0ID0gcHJvdmVuYW5jZS5XYWxsZXQuZnJvbVByaXZhdGVLZXkoXG4gICAgICBwcml2YXRlS2V5LFxuICAgICAgY2hhaW5Db2RlLFxuICAgICAgdGhpcy5lbnZpcm9ubWVudCA9PT0gXCJNQUlOX05FVFwiID8gdHJ1ZSA6IGZhbHNlXG4gICAgKTtcbiAgICBjb25zdCBnZXRLZXkgPSB3YWxsZXQuZ2V0S2V5KDAsIDApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHByaXZhdGVLZXk6IHByaXZhdGVLZXkudG9TdHJpbmcoXCJoZXhcIiksXG4gICAgICBhZGRyZXNzOiBnZXRLZXkuYWRkcmVzcyxcbiAgICAgIHB1YmxpY0tleTogZ2V0S2V5LnB1YmxpY0tleSxcbiAgICAgIG1uZW1vbmljUGhyYXNlOiBtbmVtb25pYyxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgZ2V0QmFsYW5jZShhZGRyZXNzOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jbGllbnQuZ2V0QmFsYW5jZShhZGRyZXNzLCBcIm5oYXNoXCIpO1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25EZXRhaWxzKFxuICAgIHR4SGFzaDogc3RyaW5nXG4gICk6IFByb21pc2U8UHJvdmVuYW5jZVRyYW5zYWN0aW9uRGV0YWlscz4ge1xuICAgIGNvbnN0IGZhdWNldFR4OiBJbmRleGVkVHggPSBhd2FpdCB0aGlzLmNsaWVudC5nZXRUeCh0eEhhc2gpO1xuXG4gICAgY29uc3QgZGVjb2RlZFR4OiBUeCA9IFR4LmRlY29kZShmYXVjZXRUeC50eCk7XG5cbiAgICBjb25zdCBzZW50TWVzc2FnZTogTXNnU2VuZCA9IE1zZ1NlbmQuZGVjb2RlKFxuICAgICAgZGVjb2RlZFR4LmJvZHkubWVzc2FnZXNbMF0udmFsdWVcbiAgICApO1xuICAgIGNvbnN0IGhhc2ggPSBOdW1iZXIoc2VudE1lc3NhZ2UuYW1vdW50WzBdLmFtb3VudCkgLyAxZTk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNlbmRlckFkZHJlc3M6IHNlbnRNZXNzYWdlLmZyb21BZGRyZXNzLFxuICAgICAgcmVjZWl2ZXJBZGRyZXNzOiBzZW50TWVzc2FnZS50b0FkZHJlc3MsXG4gICAgICB0b2tlbk1pbnRBZGRyZXNzOiBzZW50TWVzc2FnZS5hbW91bnRbMF0uZGVub20sXG4gICAgICBhbW91bnQ6IGhhc2gsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVRyYW5zYWN0aW9uKFxuICAgIHNlbmRlckFkZHJlc3M6IHN0cmluZyxcbiAgICByZWNlaXZlckFkZHJlc3M6IHN0cmluZyxcbiAgICBzZW5kZXJNbmVtb25pYzogc3RyaW5nLFxuICAgIGFtb3VudDogbnVtYmVyXG4gICk6IFByb21pc2U8eyBnYXNVc2VkOiBudW1iZXI7IGdhc1dhbnRlZDogbnVtYmVyOyB0cmFuc2FjdGlvbkhhc2g6IHN0cmluZyB9PiB7XG4gICAgYW1vdW50ID0gMTAwMDAwMDAwMCAqIGFtb3VudDtcbiAgICBjb25zdCBzZW5kZXJCYWxhbmNlID0gYXdhaXQgdGhpcy5nZXRCYWxhbmNlKHNlbmRlckFkZHJlc3MpO1xuICAgIGlmIChOdW1iZXIoc2VuZGVyQmFsYW5jZS5hbW91bnQpIDwgYW1vdW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBTZW5kZXIgYWNjb3VudCBiYWxhbmNlIG5vdCBzdWZmaWNpZW50LiBDdXJyZW50IGJhbGFuY2UgJHtzZW5kZXJCYWxhbmNlLmFtb3VudH1gXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHBhdGggPSBzdHJpbmdUb1BhdGgoXG4gICAgICB0aGlzLmVudmlyb25tZW50ID09PSBcIk1BSU5fTkVUXCJcbiAgICAgICAgPyBQUk9WRU5BTkNFX0NPTkZJRy5NQUlOX05FVC5QUk9WRU5BTkNFX0hEUEFUSFxuICAgICAgICA6IFBST1ZFTkFOQ0VfQ09ORklHLlRFU1RfTkVULlBST1ZFTkFOQ0VfSERQQVRIXG4gICAgKTtcblxuICAgIGNvbnN0IHNpZ25lcjogT2ZmbGluZURpcmVjdFNpZ25lciA9XG4gICAgICBhd2FpdCBEaXJlY3RTZWNwMjU2azFIZFdhbGxldC5mcm9tTW5lbW9uaWMoc2VuZGVyTW5lbW9uaWMsIHtcbiAgICAgICAgcHJlZml4OlxuICAgICAgICAgIHRoaXMuZW52aXJvbm1lbnQgPT09IFwiTUFJTl9ORVRcIlxuICAgICAgICAgICAgPyBQUk9WRU5BTkNFX0NPTkZJRy5NQUlOX05FVC5QUk9WRU5BTkNFX0hSUFxuICAgICAgICAgICAgOiBQUk9WRU5BTkNFX0NPTkZJRy5URVNUX05FVC5QUk9WRU5BTkNFX0hSUCxcbiAgICAgICAgaGRQYXRoczogW3BhdGhdLFxuICAgICAgfSk7XG4gICAgY29uc3Qgc2lnbmVyQWNjb3VudCA9IGF3YWl0IHNpZ25lci5nZXRBY2NvdW50cygpO1xuICAgIGNvbnN0IHNpZ25lckFkZHJlc3MgPSBzaWduZXJBY2NvdW50WzBdLmFkZHJlc3M7XG4gICAgaWYgKHNpZ25lckFkZHJlc3MgIT09IHNlbmRlckFkZHJlc3MpIHtcbiAgICB9XG5cbiAgICBjb25zdCBzaWduaW5nQ2xpZW50ID0gYXdhaXQgU2lnbmluZ1N0YXJnYXRlQ2xpZW50LmNvbm5lY3RXaXRoU2lnbmVyKFxuICAgICAgdGhpcy5lbnZpcm9ubWVudCA9PT0gXCJNQUlOX05FVFwiXG4gICAgICAgID8gUFJPVkVOQU5DRV9DT05GSUcuTUFJTl9ORVQuUFJPVkVOQU5DRV9SUENfVVJMXG4gICAgICAgIDogUFJPVkVOQU5DRV9DT05GSUcuVEVTVF9ORVQuUFJPVkVOQU5DRV9SUENfVVJMLFxuICAgICAgc2lnbmVyXG4gICAgKTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNpZ25pbmdDbGllbnQuc2VuZFRva2VucyhcbiAgICAgIHNpZ25lckFkZHJlc3MsXG4gICAgICByZWNlaXZlckFkZHJlc3MsXG4gICAgICBbeyBkZW5vbTogXCJuaGFzaFwiLCBhbW91bnQ6IGFtb3VudC50b1N0cmluZygpIH1dLFxuICAgICAge1xuICAgICAgICBhbW91bnQ6IFt7IGRlbm9tOiBcIm5oYXNoXCIsIGFtb3VudDogXCIyNTAyMDA3OTUwXCIgfV0sXG4gICAgICAgIGdhczogXCIxMzEzMzlcIixcbiAgICAgIH1cbiAgICApO1xuICAgIHJldHVybiB7XG4gICAgICBnYXNVc2VkOiByZXN1bHQuZ2FzVXNlZCxcbiAgICAgIGdhc1dhbnRlZDogcmVzdWx0Lmdhc1dhbnRlZCxcbiAgICAgIHRyYW5zYWN0aW9uSGFzaDogcmVzdWx0LnRyYW5zYWN0aW9uSGFzaCxcbiAgICB9O1xuICB9XG59XG4iXX0=